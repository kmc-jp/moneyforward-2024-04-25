# HTTP server

このプログラムは、Go 言語を使用した HTTP サーバです。

一般的な HTTP サーバは、Web ブラウザに代表される HTTP クライアントからのリクエストに対して、HTML ページなどのコンテンツを返します。
この HTTP サーバは、あるパスにアクセスすると、固定のテキストを返す非常に簡易的なものです。

## 事前準備

このプログラムを実行する前に、マシンに Go がインストールされていることを確認してください。
Go をダウンロードしてインストールするには、[公式ウェブサイト](https://golang.org/) を参照してください。

code-server を使用している場合は、Go がデフォルトでインストールされているため、この手順は不要です。

## プログラムを実行する

プログラムを実行するには、次の手順に従ってください：

1. ターミナルを開きます
1. `main.go` ファイルがあるディレクトリに移動します
1. 次のコマンドを実行します：

```bash
go run main.go
```

これで、HTTP サーバが起動します。
この HTTP サーバに対して、HTTP リクエストを行うことで、固定のテキストが返されます。

この HTTP サーバはポート `8080` で接続を待機します。
そのため、ブラウザで `http://localhost:8080` にアクセスすることで、固定のテキスト `Hello, World!` が表示されます。

## サーバに HTTP クライアントを利用してアクセスする

このプログラムを実行した状態で、別のターミナルを開き、次のコマンドを実行してください：

```bash
curl http://localhost:8080
```

このコマンドを実行すると、HTTP サーバから `Hello, World!` というテキストが返されていることを確認できます。

また、もし Go の HTTP クライアントが作成できていた場合は、そのクライアントを使用して HTTP サーバにアクセスすることもできます。

```bash
go run ../http_client/main.go http://localhost:8080
```

## コードの説明

Go 言語の標準の HTTP サーバライブラリを使用すると、`http.HandleFunc()` という関数を使って「アクセスするパスのパターン」と「その時に呼び出される関数」を登録することで、HTTP サーバを作成できます。
たとえば、次のように記述することで、`/` にアクセスがあったときに `handler` という関数が呼び出されるようになります。

```go
http.HandleFunc("/", handler)
```

なお、`/` はパターンであり、この記述方法では `/` だけではなく `/xyz` など `/` のあとに任意の文字列が続くパスにもマッチします。
すなわち「`/` で始まるすべてのパス」へのアクセスで `handler` という関数が呼び出されます。

詳しい仕様は、[ドキュメント](https://pkg.go.dev/net/http#hdr-Patterns) を参照してください。

`http.ListenAndServe()` という関数は、指定されたポートで HTTP サーバを起動します。
この関数を呼び出すことで、このプログラムが HTTP サーバとして動き始めます。

`handler` という関数は、HTTP リクエストを受け取り、レスポンスを返すための関数です。
ここでは、`fmt.Fprintf()` という関数を利用して、`Hello, World!` という文字列を HTTP レスポンスとして返しています。

## 演習

いろいろ改造してみましょう。

### リクエストされたパスによって、返すテキストを変える

`/abc` というパスにアクセスがあったときに、`Hello, ABC!` と返すようにしましょう。

<details>
  <summary>ヒント</summary>

新しい `handler_abc` のような関数を作成し、`http.HandleFunc()` で `/abc` のパスに対してその関数を登録してみましょう。

</details>

### アクセスログを出力する

この HTTP サーバにアクセスがあったときに、アクセスログをコンソールに出力するようにしましょう。

<details>
  <summary>ヒント</summary>

`http.HandleFunc()` 関数で登録する関数内で、`fmt.Println()` 関数を使うことでログが出力できます。

Go には `log` というライブラリも存在しており、それを使うことでより便利にログを出力できます。
たとえば、`log.Println()` 関数を使うことで、日付や時刻などの情報もログに含めることができます。

また、`handler` 関数の引数に渡される `*http.Request` という型の引数 `r` には、リクエストの内容が入っています。
`r.URL.Path` という変数には、リクエストされたパスが入っているので、これをログに出力することで、アクセスされたパスを簡単に確認できます。

</details>

### ユーザーエージェント文字列を返す

この HTTP サーバにアクセスがあったときに、アクセスしてきたクライアントのユーザーエージェント文字列を返すようにしましょう。

ユーザーエージェント文字列とは、アクセスしてきたクライアントの種類やバージョンなどを示す文字列です。
たとえば、Mac の Google Chrome では次のような文字列になります。

```
Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36
```

ユーザーエージェント文字列は、`handler` 関数の引数に渡される `*http.Request` という型の引数 `r` の中に入っており、`r.Header.Get("User-Agent")` とすると取り出せます。
